#Tekton Manifest Based Installation -https://github.com/tektoncd/chains#installation
- name: Install Tekton Chains via Manifest
  shell: |
    oc apply -f https://storage.googleapis.com/tekton-releases/chains/previous/"{{ tekton_chain_version }}"/release.yaml
  when: tekton_install_type == "manifest"

#Tekton CR Based Installation - https://docs.openshift.com/container-platform/4.10/cicd/pipelines/using-tekton-chains-for-openshift-pipelines-supply-chain-security.html
- name: Install Tekton Chains via Pipeline CR
  k8s:
    state: present
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - ./templates/tektonchain-cr.yaml.j2
  when: tekton_install_type != "manifest"

- name: Apply TektonChain Controller SCC
  shell: |
    oc project {{ tekton_operator_namespace }} && oc adm policy add-scc-to-user nonroot -z tekton-chains-controller

# Wait Until TektonChain Controller Pod Is Ready
- name: Get TektonChain Pod
  kubernetes.core.k8s_info:
    kind: Pod
    api_version: v1
    namespace: "{{ tekton_operator_namespace }}"
    label_selectors:
     - app = tekton-chains-controller
    wait: yes
  retries: 3
  delay: 20

- name: Patch the CM of Openshift Piplines to enable Tekton Chains
  command: oc patch configmap chains-config -n {{ tekton_operator_namespace }} -p='{"data":{'\"{{ item.key }}\"':'\"{{ item.value }}\"'}}'
  loop: "{{ tekton_chain_keys | dict2items }}"

- name: Recreate Tekton Chain Controller
  shell: |
    oc delete po -l app=tekton-chains-controller -n "{{ tekton_operator_namespace }}"